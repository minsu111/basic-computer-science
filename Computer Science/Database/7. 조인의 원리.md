# 조인의 원리

## 목차

- [개요](#개요)
- [중첩 루프 조인(NLJ, Nested Loop Join)](#중첩-루프-조인nlj-nested-loop-join)
- [정렬 병합 조인(Sort Merge Join)](#정렬-병합-조인sort-merge-join)
- [해시 조인](#해시-조인)
- [참고 자료](#참고-자료)

## 개요

조인의 수행 원리에 대해 알아봅니다.

## 중첩 루프 조인(NLJ, Nested Loop Join)

- 의미: **중첩 for문과 유사한 방식**으로 조인을 수행하는 방법
- 외부테이블과 내부테이블
  - 두 개의 테이블에서 조인을 수행 할 때, 테이블의 데이터에 접근하는 우선순위에 따라 먼저 접근하는 테이블을 외부 테이블(outer table), 외부 테이블 검색 결과를 통해 이후에 접근하는 테이블을 내부 테이블(inner table)이라고 한다.
    <br> \*_외부 테이블 = 드라이빙 테이블, 내부 테이블 = 드리븐 테이블_
- 특징
  - **메모리 사용량**이 적다.
  - **내부 테이블의 인덱스 구성 전략**이 매우 중요한 요소가 된다.
    - 만약 인덱스가 존재하지 않는다면 외부 테이블에서 조회되는 건마다 내부 테이블을 full scan한다.
    - 이 때 optimizer는 정렬 병합 조인 또는 해시 조인을 고려한다.
  - **부분 범위 처리**에 유리하다.
  - 랜덤 접근에 대한 비용이 증가하므**로 대량의 테이블을 조인하는 방식으로는 적절하지 않다.**
    - 보통 OLTP성 환경의 쿼리에 적절하다.
      > OLTP: 온라인 뱅킹, 쇼핑, 주문 입력 또는 텍스트 메시지 전송 등 동시에 발생하는 다수의 트랜잭션을 실행하는 데이터 처리 유형
  - 조인 순서를 찾는 것이 중요하다.
    - 어떤 테이블이 외부 테이블, 또는 내부 테이블이 되는지에 따라서 외부 루프의 범위가 결정된다.
    - 소량의 데이터를 가진 테이블을 외부 테이블로 설정하는 것이 성능에 유리하다.

## 정렬 병합 조인(Sort Merge Join)

- 의미: 두 테이블을 **조인 컬럼 기준으로 정렬**한 후 조인하는 방법
- 특징
  - 내부테이블에 적절한 인덱스가 없어 NLJ를 쓰기에 비효율적이라고 판단되거나, 출력해야 할 결과 값이 많을 때 사용한다.
  - 스캔 방식을 사용한다.
    - 테이블 랜덤 접근이 일어나지 않는다.
    - 정렬 후 테이블을 순차적으로 스캔하기 때문에 **인덱스를 사용하지 않는다.**
    - 각 테이블을 1회씩만 읽기 때문에 더 효율적이다.
  - Equal Join이 아닌 범위로 조인을 하는 쿼리에서도 적절한 수행 원리이다.
  - 정렬 작업이 PGA 영역에서 수행되기 때문에 경합이 발생하지 않아 성능에 유리한 이점이 있다.
  - 정렬 작업에 의한 비용이 발생한다.

## 해시 조인

- 의미: **해시 테이블**을 기반으로 조인하는 방법
- 특징
  - 배치에서 쓰면 좋은 수행 원리이다.
  - 대용량 테이블을 조인할 때 이용하면 좋다.
  - key 컬럼에 중복값이 없을수록 성능에 유리하다.
  - equal join만 가능하다.
  - 랜덤 접근이 일어나지 않는다.
  - 해시 영역에 들어가는 테이블의 크기가 충분히 작아야 성능에 유리하다.
    - 해시 영역의 정해진 사이즈를 초과하면 디스크 영역을 사용하기 때문에 성능이 저하된다.
- 해시 조인의 단계
  - 빌드 단계: 테이블 중 하나를 기반으로 메모리 내 해시 테이블을 빌드하는 단계
    - 두 개 테이블 중 바이트가 더 작은 테이블(build input)을 기반으로 해시 테이블을 빌드한다.
  - 프로브 단계: 조인 컬럼을 가지고 큰 쪽 테이블(probe input)을 읽어 탐색하면서 조인하는 단계

## 참고 자료

- 본문 출처
- [면접을 위한 CS 전공지식 노트(주홍철)](https://product.kyobobook.co.kr/detail/S000001834833?utm_source=google&utm_medium=cpc&utm_campaign=googleSearch&gt_network=g&gt_keyword=&gt_target_id=aud-901091942354:dsa-435935280379&gt_campaign_id=9979905549&gt_adgroup_id=132556570510&gad_source=1&gclid=Cj0KCQjwwYSwBhDcARIsAOyL0fhby9LTtW8HLZ5Wg0aW9oKf_EyHPNtAttNCtkeyvmU4HlWw4sGx6VYaAnT5EALw_wcB)
- [https://devlog.changhee.me/posts/Join기법\_정리/](https://devlog.changhee.me/posts/Join%EA%B8%B0%EB%B2%95_%EC%A0%95%EB%A6%AC/)
- [https://velog.io/@subutai/DB-RDB의-조인종류-및-방식-1y5paiap](https://velog.io/@subutai/DB-RDB%EC%9D%98-%EC%A1%B0%EC%9D%B8%EC%A2%85%EB%A5%98-%EB%B0%8F-%EB%B0%A9%EC%8B%9D-1y5paiap)
- https://ryean.tistory.com/73
